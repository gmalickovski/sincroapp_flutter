name: Deploy SincroApp Web & VPS

# Dispara APENAS quando você sobe uma tag de versão (v1.0.0, etc)
on:
  push:
    tags:
      - 'v*'

jobs:
  deploy-web:
    name: Build & Deploy Web
    runs-on: ubuntu-latest
    
    steps:
      # 1. Baixa o código do repositório
      - uses: actions/checkout@v3

      # 2. Prepara o Flutter no ambiente do GitHub
      - uses: subosito/flutter-action@v2
        with:

          channel: 'stable'

      # 3. Baixa as dependências
      - name: Install dependencies
        run: flutter pub get

      # Cria o arquivo .env (necessário para o build)
      - name: Create .env
        run: |
          if [ -n "${{ secrets.ENV_FILE }}" ]; then
            echo "${{ secrets.ENV_FILE }}" > .env
          else
            touch .env
          fi

      # 4. COMPILA O SITE
      - name: Build Web
        run: flutter build web --release --no-tree-shake-icons

      # 5. Conecta na sua VPS e envia SÓ os arquivos prontos
      - name: Deploy to VPS via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 2222
          # Copia o conteúdo da pasta build/web do GitHub para sua VPS
          source: "build/web/*"
          target: "/var/www/webapp/sincroapp_flutter/build/web" # Caminho onde o Nginx lê o site
          strip_components: 2 # Remove 'build/web' do caminho ao copiar

      # 6. Atualiza o Backend (Node.js) na mesma sequência
      - name: Restart Node Backend via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 2222
          script: |
            # Comandos que rodam dentro da sua VPS
            echo "Iniciando atualização do Backend..."
            
            # Navega para a pasta do projeto (conforme update.sh)
            cd /var/www/webapp/sincroapp_flutter
            
            # Atualiza o código (Backend e estrutura)
            git pull origin main
            
            # Navega para o servidor (Backend)
            cd server
            
            # Instala dependências e reinicia
            npm install
            pm2 restart sincroapp-server
            
            # Reinicia notificações se existir (conforme update.sh)
            pm2 restart sincroapp-notifications || true

            # Ajusta permissões do Frontend Web (crítico para Nginx)
            echo "Ajustando permissões e recarregando Nginx..."
            chown -R www-data:www-data /var/www/webapp/sincroapp_flutter/build/web
            chmod -R 755 /var/www/webapp/sincroapp_flutter/build/web
            systemctl reload nginx
            
            echo "Backend atualizado, Nginx recarregado e serviços operacionais!"
