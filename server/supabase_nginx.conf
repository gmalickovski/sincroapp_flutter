server {
    server_name supabase.studiomlk.com.br;

    # Aumentar limite para fotos do SincroApp (suporta uploads de até 20MB)
    client_max_body_size 20M;

    # 1. Painel Administrativo (Studio) - Porta 7200
    location / {
        proxy_pass http://localhost:7200;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. REALTIME / WEBSOCKETS (Configuração Específica)
    # Separado para garantir timeouts longos e headers de Upgrade corretos
    # Isso resolve o erro "WebSocket connection failed"
    location ~ ^/realtime/v1/ {
        proxy_pass http://localhost:7300;
        
        # Headers OBRIGATÓRIOS para WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade"; # "Upgrade" com U maiúsculo é mais compatível
        proxy_set_header Host $host;
        
        # Timeouts longos para manter o WebSocket aberto e evitar desconexões
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Headers de Proxy padrão
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. API, Auth e Storage (Restante dos serviços) - Porta 7300
    # Removido 'realtime' daqui pois já tem regra específica acima
    location ~ ^/(rest|auth|storage)/v1/ {
        proxy_pass http://localhost:7300;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Configurações de SSL Gerenciadas pelo Certbot ---
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/supabase.studiomlk.com.br/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/supabase.studiomlk.com.br/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = supabase.studiomlk.com.br) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name supabase.studiomlk.com.br;
    return 404; # managed by Certbot
}
